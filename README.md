#第三方授权登陆服务功能

---

###version

**0.3**


###方案目标

1. 对方系统用户可以对接到我方系统
2. 我方系统用户可以对接到对方系统
3. 对方系统可以使用`自己的货币`按照固定的`汇率`在我方消费

###方案设计大致思路

* 我们使用一个单独的微服务去处理所有类似的第三方交互,解耦前端服务层和不同平台数据交互性
* 尽量做到对以后所有第三方来源的兼容,且所有功能封装在一个独立的微服务内.
* 不做硬性数据导入,而是做`授权`模式
* 我们需要做好一个数据适配器和翻译器功能针对不同站点的导入
* 对外提供使用统一的`http://jsonapi.org/`接口数据格式
* 我们不导出任何用户隐私信息(密码)
* 统一入口为我们`API网关`(单独一个授权api网关,需要对外网开放的),可以针对这一个单独网关做`https`和`token`的校验.
* `token`前期暂时可以考虑写入在`header`内.

###方案需求

* 对方用户模块开发程序人员
* 对方查询用户信息接口,校验模式需对方提供
* 我方查询用户信息接口,校验模式我方提供
* 对方扣费(海米)接口,校验模式需对方提供
* 可以先交付一个沙箱场景用于测试

###描述用户场景

**目标方跳入我方**

用户在启德商城`点击`一张推广图片跳到我方任意一个子站点(拥有独立域名),首先这张图片的链接需要包含如下信息.

* 包含来源网站信息(可以用一个唯一字符串来代替)
* 包含目标链接地址
* 包含用户的信息(可以是一个用户的`id`,`手机号`或者任意一个唯一的标识)

导入我方流程设计

* 我们根据`来源`选择对方接口去查询数据(根据对方的用户唯一标识),因为有适配器和翻译器的存在我们可以独立的还原我们需要的数据
* 我们需要对方接口返回如下信息:
	* 用户名(如果有,如果没有则我们默认用手机号当做用户名)
	* 手机号
	* 昵称
* 如果该`手机号`(没有手机号按照`用户名`)没有在我方注册过
	* 以上数据`入我们的库`(通过用户服务接口),类似实现注册
	* 我们`不保存`密码,在我方我们额外保存一个标识表示用户来源于某个第三方
	* 当cookie过期失效,我们在去接口获取数据
* 如果该`手机号`(没有手机号按照`用户名`)在我方注册过
	* 根据`用户名`(手机号)去我方接口查找用户数据返回
	* `标记`用户为`已登陆`

**我方跳入目标方**

我方需要处理如下:

* 我方提供`查询用户接口`,该接口是单独的`API网关`,我方只能返回如下信息:
	* 用户名
	* 昵称
	* 手机号(`如果有,微信用户则没有手机号`)
* 格式为`jsonapi.org`

###支付模式

* 我方需要一个支付扣费的接口
* 提供费率
* 我方支付的时候,如果选择使用第三方支付(海米),则会进行如下流程交互
	* 前端服务层访问后端服务层,传递扣费金额(类似微信支付,但是没有回调处理)
	* 后端服务层访问第三方的扣费链接进行扣费,如果成功则返回"成功".
	* 前端服务层继续走订单流程


###我方用户接口样例代码

* xxxx.xxx.com/users?filter[cellPhone]=15202939422
* GET 请求

		string(656) "{
		    "data": {
		        "type": "users",
		        "id": "13",
		        "attributes": {
		            "cellPhone": "15202939422",
		            "nickName": "15202939422",
		            "userName": "ACaY1475853051",
		            "status": 0,
		            "createTime": 1475853051,
		            "updateTime": 1475853051,
		            "statusTime": 1475853051,
		            "openId": ""
		        },
		        "relationships": {
		            "shops": {
		                "data": {
		                    "type": "shops",
		                    "id": "1"
		                }
		            }
		        },
		        "links": {
		            "self": xxxx.xxxx.com\/users\/13"
		        }
		    }
		}"

这个只是我们其中一个服务的样例代码,具体返回字段待确定.

###沟通记录

* 2016.11.10 交付对方等待对方确认